workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
    - if: '$CI_COMMIT_TAG'

stages:
  - validate
  - test
  - build
  - release

image: node:20

cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/

# GitLab security templates (secret detection, etc.)
include:
  - template: Security/Secret-Detection.gitlab-ci.yml

# ----- VALIDATE -----
install:
  stage: validate
  script:
    - npm ci --cache .npm --prefer-offline

lint:
  stage: validate
  needs: ["install"]
  script:
    - npm run lint

audit:
  stage: validate
  needs: ["install"]
  script:
    - npm audit --audit-level=moderate
  allow_failure: true

# ----- TEST -----
unit-test:
  stage: test
  needs: ["install"]
  script:
    - npm test

e2e-test:
  stage: test
  needs: ["unit-test"]
  script:
    - npm run test:e2e

# ----- BUILD -----
build-image:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    IMAGE_SHA: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    IMAGE_LATEST: $CI_REGISTRY_IMAGE:latest
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build --platform=linux/amd64 -t $IMAGE_SHA -t $IMAGE_LATEST .
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag $IMAGE_SHA $IMAGE_TAG
      fi
    - docker push $CI_REGISTRY_IMAGE --all-tags

# ----- RELEASE -----
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs: ["build-image"]
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - echo "Create GitLab release for $CI_COMMIT_TAG"
  release:
    tag_name: "$CI_COMMIT_TAG"
    name: "Release $CI_COMMIT_TAG"
    description: "Release automatique via pipeline (exo6 IA)"

check-google-key:
  stage: validate
  script:
    - node -e "console.log('HAS GOOGLE_API_KEY?', !!process.env.GOOGLE_API_KEY)"
